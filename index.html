<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iTabs SKILL.md Presenter</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1419; color: #e7e9ea; line-height: 1.6; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; font-size: 2rem; margin-bottom: 10px; color: #7856ff; }
        .subtitle { text-align: center; color: #8b98a5; margin-bottom: 30px; }
        .ai-mode-banner { background: linear-gradient(135deg, rgba(0,186,124,0.2), rgba(120,86,255,0.2)); border: 1px solid #00ba7c; border-radius: 8px; padding: 12px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .ai-mode-banner .icon { font-size: 1.5rem; }
        .ai-mode-banner .text { color: #00ba7c; font-weight: 600; }
        .ai-mode-banner .subtext { color: #8b98a5; font-size: 13px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
        .panel { background: #1a1f26; border-radius: 12px; padding: 20px; border: 1px solid #2f3336; }
        .panel h2 { font-size: 1rem; margin-bottom: 15px; color: #8b98a5; }
        textarea { width: 100%; height: 350px; background: #0f1419; border: 1px solid #2f3336; border-radius: 8px; padding: 15px; color: #e7e9ea; font-family: monospace; font-size: 14px; resize: vertical; }
        textarea:focus { outline: none; border-color: #7856ff; }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        button { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #7856ff; color: white; }
        .btn-primary:hover { background: #6344dd; }
        .btn-secondary { background: #2f3336; color: #e7e9ea; }
        .btn-secondary:hover { background: #3f4448; }
        .btn-green { background: #00ba7c; color: white; }
        .btn-green:hover { background: #00a06a; }
        .btn-blue { background: #1d9bf0; color: white; }
        .btn-blue:hover { background: #1a8cd8; }
        .preview { background: #0f1419; border-radius: 8px; padding: 20px; min-height: 350px; border: 1px solid #2f3336; }
        .preview-empty { color: #8b98a5; text-align: center; padding-top: 100px; }
        .ai-output-mode .grid { grid-template-columns: 1fr; }
        .ai-output-mode .input-panel { display: none; }
        #jsonOutput { display: none; background: #0f1419; border: 1px solid #2f3336; border-radius: 8px; padding: 15px; margin-top: 15px; font-family: monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto; }
        .skill-header { background: linear-gradient(135deg, rgba(120,86,255,0.2), rgba(29,155,240,0.2)); border: 1px solid #7856ff; border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .skill-header h3 { color: #7856ff; margin-bottom: 8px; }
        .skill-header p { color: #8b98a5; font-size: 14px; }
        .itab { background: #1a1f26; border: 1px solid #2f3336; border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
        .itab-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; }
        .itab-header:hover { background: #242b35; }
        .itab-title { display: flex; align-items: center; gap: 10px; }
        .itab-num { width: 28px; height: 28px; background: #7856ff; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        .itab-name { font-weight: 600; }
        .itab-toggle { width: 26px; height: 26px; background: #7856ff; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; }
        .itab-toggle.open { background: #00ba7c; }
        .itab-content { display: none; padding: 15px; border-top: 1px solid #2f3336; color: #8b98a5; }
        .itab-content.show { display: block; }
        .itab-content p { margin: 10px 0; }
        .itab-content ul, .itab-content ol { margin: 10px 0; padding-left: 20px; }
        .itab-content li { margin: 5px 0; }
        .itab-content strong { color: #e7e9ea; }
        .itab-content code { background: #0f1419; padding: 2px 6px; border-radius: 4px; }
        .itab-content pre { background: #0f1419; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>iTabs SKILL.md Presenter</h1>
        <p class="subtitle">Ugly file in ‚Üí Beautiful preview out</p>
        <div class="ai-mode-banner" id="aiBanner" style="display: none;">
            <span class="icon">ü§ñ</span>
            <div>
                <div class="text">AI Mode Active</div>
                <div class="subtext">Content loaded automatically from URL parameters</div>
            </div>
        </div>
        <div class="grid">
            <div class="panel input-panel">
                <h2>üìÑ Paste SKILL.md</h2>
                <textarea id="input" placeholder="Paste your SKILL.md content here..."></textarea>
                <div class="btn-row">
                    <button class="btn-primary" id="convertBtn">Convert to iTabs</button>
                    <button class="btn-secondary" id="exampleBtn">Load Example</button>
                    <button class="btn-secondary" id="clearBtn">Clear</button>
                </div>
            </div>
            <div class="panel">
                <h2>üëÅÔ∏è Preview</h2>
                <div class="preview" id="preview">
                    <div class="preview-empty">Paste a SKILL.md and click Convert</div>
                </div>
                <div class="btn-row">
                    <button class="btn-green" id="downloadBtn" style="display:none;">Download iTabs HTML</button>
                    <button class="btn-blue" id="downloadSkillBtn" style="display:none;">Download SKILL.md</button>
                    <button class="btn-secondary" id="copyJsonBtn" style="display:none;">Copy JSON</button>
                </div>
                <div id="jsonOutput"></div>
            </div>
        </div>
        <div class="panel" style="margin-top: 20px;">
            <h2>ü§ñ AI / API Usage</h2>
            <p style="color: #8b98a5; margin-bottom: 15px;">AIs can call this tool directly using URL parameters:</p>
            <pre style="background: #0f1419; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 13px; color: #00ba7c;">https://boilermaker-innovator.github.io/iTabs-skillmd-presenter/?content=URL_ENCODED_SKILL_CONTENT</pre>
            <p style="color: #8b98a5; margin-top: 15px; font-size: 13px;"><strong>Parameters:</strong></p>
            <ul style="color: #8b98a5; margin-left: 20px; font-size: 13px;">
                <li><code style="background: #0f1419; padding: 2px 6px; border-radius: 4px;">content</code> - URL-encoded SKILL.md content (required)</li>
                <li><code style="background: #0f1419; padding: 2px 6px; border-radius: 4px;">autoconvert=true</code> - Auto-convert on load (default: true)</li>
                <li><code style="background: #0f1419; padding: 2px 6px; border-radius: 4px;">output=json</code> - Return JSON instead of preview</li>
                <li><code style="background: #0f1419; padding: 2px 6px; border-radius: 4px;">expand=all</code> - Auto-expand all sections</li>
            </ul>
        </div>
    </div>
<script>
var parsedData = null;
var originalSource = null;
var input = document.getElementById('input');
var preview = document.getElementById('preview');
var convertBtn = document.getElementById('convertBtn');
var exampleBtn = document.getElementById('exampleBtn');
var clearBtn = document.getElementById('clearBtn');
var downloadBtn = document.getElementById('downloadBtn');
var downloadSkillBtn = document.getElementById('downloadSkillBtn');
var copyJsonBtn = document.getElementById('copyJsonBtn');
var jsonOutput = document.getElementById('jsonOutput');
var aiBanner = document.getElementById('aiBanner');

window.onload = function() {
    var params = new URLSearchParams(window.location.search);
    var content = params.get('content');
    var autoconvert = params.get('autoconvert') !== 'false';
    var outputFormat = params.get('output');
    var expandAll = params.get('expand') === 'all';
    if (content) {
        try {
            var decoded = decodeURIComponent(content);
            input.value = decoded;
            originalSource = decoded;
            aiBanner.style.display = 'flex';
            document.body.classList.add('ai-output-mode');
            if (autoconvert) {
                parseAndRender(decoded, expandAll);
                if (outputFormat === 'json') { showJsonOutput(); }
            }
        } catch (e) { console.error('Failed to decode content:', e); }
    }
};

convertBtn.onclick = function() {
    var text = input.value.trim();
    if (!text) { alert('Please paste SKILL.md content first'); return; }
    originalSource = text;
    parseAndRender(text, false);
};

exampleBtn.onclick = function() {
    input.value = '---\nname: rsa-compliance-helper\ndescription: Helps hospitality workers understand RSA rules for serving alcohol responsibly.\n---\n\n# RSA Compliance Helper\n\nYou are helping hospitality workers in Australia understand RSA rules.\n\n## Signs of Intoxication\n\nLook for these signs:\n\n- Slurred speech\n- Loss of coordination\n- Loud behaviour\n- Aggressive attitude\n- Drowsy or falling asleep\n- Spilling drinks\n\n**Important:** Look for multiple signs, not just one.\n\n## How to Refuse Service\n\nFollow these steps:\n\n1. Stay calm and polite\n2. Be firm but not aggressive\n3. Say "I cannot serve you any more alcohol tonight"\n4. Offer water or food instead\n5. Get manager if they argue\n\n## When to Call for Help\n\nCall security when:\n\n- Patron becomes aggressive\n- Patron will not leave\n- Patron tries to drive\n- You feel unsafe';
    originalSource = input.value;
    parseAndRender(input.value, false);
};

clearBtn.onclick = function() {
    input.value = '';
    preview.innerHTML = '<div class="preview-empty">Paste a SKILL.md and click Convert</div>';
    downloadBtn.style.display = 'none';
    downloadSkillBtn.style.display = 'none';
    copyJsonBtn.style.display = 'none';
    jsonOutput.style.display = 'none';
    parsedData = null;
    originalSource = null;
    window.history.replaceState({}, '', window.location.pathname);
    aiBanner.style.display = 'none';
    document.body.classList.remove('ai-output-mode');
};

downloadBtn.onclick = function() {
    if (!parsedData) return;
    var html = generateHTML();
    var blob = new Blob([html], {type: 'text/html'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = parsedData.name.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '-itabs.html';
    a.click();
};

downloadSkillBtn.onclick = function() {
    if (!originalSource) return;
    var blob = new Blob([originalSource], {type: 'text/markdown'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (parsedData ? parsedData.name.replace(/[^a-z0-9]/gi, '-').toLowerCase() : 'skill') + '-SKILL.md';
    a.click();
};

copyJsonBtn.onclick = function() {
    if (!parsedData) return;
    var json = JSON.stringify(parsedData, null, 2);
    navigator.clipboard.writeText(json).then(function() {
        copyJsonBtn.textContent = 'Copied!';
        setTimeout(function() { copyJsonBtn.textContent = 'Copy JSON'; }, 2000);
    });
};

function showJsonOutput() {
    if (!parsedData) return;
    jsonOutput.style.display = 'block';
    jsonOutput.textContent = JSON.stringify(parsedData, null, 2);
    copyJsonBtn.style.display = 'inline-block';
}

function parseAndRender(text, expandAll) {
    var name = 'Untitled Skill';
    var description = 'No description';
    var body = text;
    if (text.indexOf('---') === 0) {
        var parts = text.split('---');
        if (parts.length >= 3) {
            var fm = parts[1];
            body = parts.slice(2).join('---');
            var nameMatch = fm.match(/name:\s*(.+)/);
            if (nameMatch) name = nameMatch[1].trim();
            var descMatch = fm.match(/description:\s*(.+)/);
            if (descMatch) description = descMatch[1].trim();
        }
    }
    var sections = [];
    var lines = body.split('\n');
    var current = null;
    var introLines = [];
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        if (line.indexOf('## ') === 0) {
            if (introLines.length > 0 && sections.length === 0 && !current) {
                var introText = introLines.join('\n').trim();
                if (introText) { sections.push({ title: 'Overview', content: introLines }); }
            }
            if (current) sections.push(current);
            current = { title: line.substring(3).trim(), content: [] };
        } else if (line.indexOf('# ') === 0 && !current) {
            if (introLines.length > 0 && sections.length === 0) {
                var introText = introLines.join('\n').trim();
                if (introText) { sections.push({ title: 'Overview', content: introLines }); }
            }
            current = { title: line.substring(2).trim(), content: [] };
        } else if (current) {
            current.content.push(line);
        } else {
            introLines.push(line);
        }
    }
    if (current) sections.push(current);
    if (sections.length === 0 && introLines.length > 0) { sections.push({ title: 'Overview', content: introLines }); }
    if (sections.length === 0) { sections.push({ title: 'Overview', content: body.split('\n') }); }
    parsedData = { name: name, description: description, sections: sections };
    var html = '<div class="skill-header"><h3>' + escapeHtml(name) + '</h3><p>' + escapeHtml(description) + '</p></div>';
    for (var j = 0; j < sections.length; j++) {
        var s = sections[j];
        var content = parseContent(s.content.join('\n'));
        var showClass = expandAll ? ' show' : '';
        var toggleClass = expandAll ? ' open' : '';
        var toggleText = expandAll ? '-' : '+';
        html += '<div class="itab"><div class="itab-header" onclick="toggleItab(this)"><div class="itab-title"><span class="itab-num">' + (j+1) + '</span><span class="itab-name">' + escapeHtml(s.title) + '</span></div><button class="itab-toggle' + toggleClass + '">' + toggleText + '</button></div><div class="itab-content' + showClass + '">' + content + '</div></div>';
    }
    preview.innerHTML = html;
    downloadBtn.style.display = 'inline-block';
    downloadSkillBtn.style.display = 'inline-block';
    copyJsonBtn.style.display = 'inline-block';
}

function toggleItab(header) {
    var content = header.nextElementSibling;
    var btn = header.querySelector('.itab-toggle');
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        btn.classList.remove('open');
        btn.textContent = '+';
    } else {
        content.classList.add('show');
        btn.classList.add('open');
        btn.textContent = '-';
    }
}

function parseContent(text) {
    if (!text.trim()) return '<p><em>No content</em></p>';
    text = text.replace(/```[\s\S]*?```/g, function(m) { return '<pre><code>' + escapeHtml(m.replace(/```\w*/g, '').trim()) + '</code></pre>'; });
    text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    var lines = text.split('\n');
    var result = [];
    var inList = false;
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        if (line.indexOf('- ') === 0) {
            if (!inList) { result.push('<ul>'); inList = true; }
            result.push('<li>' + line.substring(2) + '</li>');
        } else if (line.match(/^\d+\. /)) {
            if (!inList) { result.push('<ol>'); inList = true; }
            result.push('<li>' + line.replace(/^\d+\. /, '') + '</li>');
        } else {
            if (inList) { result.push(inList === 'ol' ? '</ol>' : '</ul>'); inList = false; }
            if (line.trim()) result.push('<p>' + line + '</p>');
        }
    }
    if (inList) result.push('</ul>');
    return result.join('') || '<p><em>No content</em></p>';
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function generateHTML() {
    var sections = '';
    for (var i = 0; i < parsedData.sections.length; i++) {
        var s = parsedData.sections[i];
        sections += '<div class="itab"><div class="itab-header" onclick="toggle(this)"><div class="itab-title"><span class="itab-num">' + (i+1) + '</span><span class="itab-name">' + escapeHtml(s.title) + '</span></div><button class="itab-toggle">+</button></div><div class="itab-content">' + parseContent(s.content.join('\n')) + '</div></div>';
    }
    
    var encodedSource = btoa(unescape(encodeURIComponent(originalSource || '')));
    
    return '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>' + escapeHtml(parsedData.name) + '</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,sans-serif;background:#0f1419;color:#e7e9ea;padding:20px;max-width:700px;margin:0 auto;line-height:1.6}.header{background:linear-gradient(135deg,rgba(120,86,255,0.2),rgba(29,155,240,0.2));border:1px solid #7856ff;border-radius:12px;padding:20px;text-align:center;margin-bottom:20px}.header h1{color:#7856ff;font-size:1.5rem;margin-bottom:8px}.header p{color:#8b98a5;font-size:14px}.btn-row{display:flex;gap:10px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}.btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer}.btn-blue{background:#1d9bf0;color:white}.btn-blue:hover{background:#1a8cd8}.itab{background:#1a1f26;border:1px solid #2f3336;border-radius:10px;margin-bottom:10px;overflow:hidden}.itab-header{display:flex;justify-content:space-between;align-items:center;padding:15px;cursor:pointer}.itab-header:hover{background:#242b35}.itab-title{display:flex;align-items:center;gap:10px}.itab-num{width:28px;height:28px;background:#7856ff;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}.itab-name{font-weight:600}.itab-toggle{width:26px;height:26px;background:#7856ff;border:none;border-radius:6px;color:white;font-weight:bold;cursor:pointer}.itab-toggle.open{background:#00ba7c}.itab-content{display:none;padding:15px;border-top:1px solid #2f3336;color:#8b98a5}.itab-content.show{display:block}.itab-content p{margin:10px 0}.itab-content ul,.itab-content ol{margin:10px 0;padding-left:20px}.itab-content li{margin:5px 0}.itab-content strong{color:#e7e9ea}.itab-content code{background:#0f1419;padding:2px 6px;border-radius:4px}.itab-content pre{background:#0f1419;padding:12px;border-radius:6px;overflow-x:auto;margin:10px 0}.footer{text-align:center;padding:20px;color:#8b98a5;font-size:12px}</style></head><body><div class="header"><h1>' + escapeHtml(parsedData.name) + '</h1><p>' + escapeHtml(parsedData.description) + '</p></div><div class="btn-row"><button class="btn btn-blue" onclick="downloadSkill()">Download SKILL.md</button></div>' + sections + '<div class="footer">Converted to iTabs format ‚Ä¢ <a href="https://boilermaker-innovator.github.io/iTabs-skillmd-presenter/" style="color:#7856ff;">Create your own</a></div><script>var src="' + encodedSource + '";function toggle(h){var c=h.nextElementSibling,b=h.querySelector(".itab-toggle");if(c.classList.contains("show")){c.classList.remove("show");b.classList.remove("open");b.textContent="+"}else{c.classList.add("show");b.classList.add("open");b.textContent="-"}}function downloadSkill(){var text=decodeURIComponent(escape(atob(src)));var blob=new Blob([text],{type:"text/markdown"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="' + parsedData.name.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '-SKILL.md";a.click()}<\/script></body></html>';
}
</script>
</body>
</html>
