<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iTabs Generator v9</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #00d4ff;
            --accent-hover: #00b8e6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #475569;
        }

```
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-dark);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.6;
    }
    
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Header */
    header {
        text-align: center;
        padding: 30px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 30px;
    }
    
    .logo {
        font-size: 2rem;
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 5px;
    }
    
    .tagline {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }
    
    .version-badge {
        display: inline-block;
        background: var(--accent);
        color: var(--bg-dark);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 10px;
    }
    
    /* Steps indicator */
    .steps {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 30px;
    }
    
    .step {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--bg-card);
        border: 2px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    
    .step.active {
        background: var(--accent);
        border-color: var(--accent);
        color: var(--bg-dark);
    }
    
    .step.done {
        background: var(--success);
        border-color: var(--success);
        color: white;
    }
    
    /* Cards/Panels */
    .panel {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 20px;
        display: none;
    }
    
    .panel.active { display: block; }
    
    .panel h2 {
        color: var(--accent);
        font-size: 1.3rem;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    /* Form elements */
    label {
        display: block;
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 8px;
    }
    
    input[type="text"],
    input[type="password"],
    input[type="email"],
    input[type="url"],
    textarea {
        width: 100%;
        padding: 12px 15px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 1rem;
        font-family: inherit;
        margin-bottom: 15px;
        transition: border-color 0.2s;
    }
    
    input:focus, textarea:focus {
        outline: none;
        border-color: var(--accent);
    }
    
    textarea {
        min-height: 200px;
        resize: vertical;
    }
    
    /* Buttons */
    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: var(--accent);
        color: var(--bg-dark);
    }
    
    .btn-primary:hover {
        background: var(--accent-hover);
    }
    
    .btn-secondary {
        background: var(--bg-input);
        color: var(--text-primary);
    }
    
    .btn-secondary:hover {
        background: var(--border);
    }
    
    .btn-success {
        background: var(--success);
        color: white;
    }
    
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn-row {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    /* Checkbox */
    .checkbox-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 15px 0;
    }
    
    .checkbox-row input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: var(--accent);
    }
    
    .checkbox-row label {
        margin: 0;
        color: var(--text-primary);
    }
    
    /* Help text */
    .help-text {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: -10px;
        margin-bottom: 15px;
    }
    
    .help-text a {
        color: var(--accent);
    }
    
    /* Status messages */
    .status {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 0.9rem;
    }
    
    .status.success {
        background: rgba(16, 185, 129, 0.2);
        border: 1px solid var(--success);
        color: var(--success);
    }
    
    .status.error {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid var(--error);
        color: var(--error);
    }
    
    .status.loading {
        background: rgba(0, 212, 255, 0.2);
        border: 1px solid var(--accent);
        color: var(--accent);
    }
    
    /* Editor sections */
    .section-editor {
        background: var(--bg-input);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border: 1px solid var(--border);
    }
    
    .section-editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .section-number {
        background: var(--accent);
        color: var(--bg-dark);
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .delete-section {
        background: transparent;
        border: none;
        color: var(--error);
        cursor: pointer;
        font-size: 1.2rem;
        padding: 5px;
    }
    
    .timestamp-badge {
        background: var(--bg-dark);
        color: var(--accent);
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-family: monospace;
    }
    
    /* Preview area */
    .preview-frame {
        width: 100%;
        height: 600px;
        border: none;
        border-radius: 12px;
        background: white;
    }
    
    /* Footer */
    footer {
        text-align: center;
        padding: 30px;
        color: var(--text-secondary);
        font-size: 0.85rem;
    }
    
    footer a {
        color: var(--accent);
        text-decoration: none;
    }
    
    /* Color picker row */
    .color-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .color-row input[type="color"] {
        width: 50px;
        height: 40px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: transparent;
    }
    
    .color-row input[type="text"] {
        flex: 1;
        margin-bottom: 0;
    }
    
    /* New feature badge */
    .new-badge {
        background: var(--warning);
        color: var(--bg-dark);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }
</style>
```

</head>
<body>
    <div class="container">
        <header>
            <div class="logo">iTabs</div>
            <div class="tagline">People learn easier and act</div>
            <div class="version-badge">v9 - Video Clips</div>
        </header>

```
    <div class="steps">
        <div class="step active" id="step1">1</div>
        <div class="step" id="step2">2</div>
        <div class="step" id="step3">3</div>
    </div>
    
    <!-- Panel 1: Setup -->
    <div class="panel active" id="panel1">
        <h2>üîë Setup</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">One-time setup. Your key stays in your browser.</p>
        
        <label>Gemini API Key</label>
        <input type="password" id="apiKey" placeholder="Paste your Gemini API key">
        <p class="help-text">Free from Google ‚Üí <a href="https://aistudio.google.com/app/apikey" target="_blank">Get your key</a></p>
        
        <div id="keyStatus"></div>
        
        <div class="btn-row">
            <button class="btn btn-primary" onclick="saveApiKey()">Save & Continue ‚Üí</button>
        </div>
    </div>
    
    <!-- Panel 2: Content Input -->
    <div class="panel" id="panel2">
        <h2>üìÑ Your Content</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Paste your source. AI will organise it into an iTabs guide with video clips.</p>
        
        <label>üé¨ YouTube Video URL</label>
        <input type="url" id="youtubeUrl" placeholder="https://youtube.com/watch?v=...">
        <p class="help-text">Each section will get a "Watch Clip" button for that part of the video <span class="new-badge">New</span></p>
        
        <div class="checkbox-row">
            <input type="checkbox" id="embedVideo" checked>
            <label for="embedVideo">Embed full video at top of guide</label>
        </div>
        
        <div class="checkbox-row">
            <input type="checkbox" id="enableClips" checked>
            <label for="enableClips">Add popup video clips for each section <span class="new-badge">New</span></label>
        </div>
        
        <label>üìù Transcript / Content</label>
        <textarea id="transcript" placeholder="Paste transcript with timestamps like [00:01:23] or 1:23...
```

Example:
[00:00:00] Welcome to this guide
[00:00:15] The first thing you need to know‚Ä¶
[00:01:30] Here‚Äôs the key concept‚Ä¶‚Äù></textarea>
<p class="help-text">Timestamps will be used to create video clips for each section</p>

```
        <label>üéØ Who is this guide for?</label>
        <input type="text" id="audience" placeholder="e.g. Tradies learning to use this tool">
        
        <label>üéØ What should they be able to DO after reading?</label>
        <input type="text" id="goal" placeholder="e.g. Set up and calibrate the saw correctly">
        
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="goToPanel(1)">‚Üê Back</button>
            <button class="btn btn-primary" onclick="generateiTabs()">Create iTabs ‚Üí</button>
        </div>
        
        <div id="generateStatus" style="margin-top: 20px;"></div>
    </div>
    
    <!-- Panel 3: Edit & Download -->
    <div class="panel" id="panel3">
        <h2>‚úèÔ∏è Edit & Download</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Review, tweak, then download your iTabs guide.</p>
        
        <label>Guide Title</label>
        <input type="text" id="guideTitle" placeholder="My iTabs Guide">
        
        <label>Prepared For (optional)</label>
        <input type="text" id="preparedFor" placeholder="e.g. Client name or company">
        
        <div class="color-row">
            <label style="margin: 0;">Brand Color</label>
            <input type="color" id="brandColor" value="#00d4ff">
            <input type="text" id="brandColorText" value="#00d4ff" placeholder="#00d4ff">
        </div>
        
        <label>Contact Email (optional)</label>
        <input type="email" id="contactEmail" placeholder="help@example.com">
        
        <div id="sectionsEditor"></div>
        
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="goToPanel(2)">‚Üê Back</button>
            <button class="btn btn-secondary" onclick="previewGuide()">üëÅÔ∏è Preview</button>
            <button class="btn btn-success" onclick="downloadGuide()">‚¨áÔ∏è Download</button>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; padding: 20px;">
        <div style="max-width: 900px; margin: 0 auto; height: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--accent);">Preview</h3>
                <button class="btn btn-secondary" onclick="closePreview()">‚úï Close</button>
            </div>
            <iframe id="previewFrame" class="preview-frame"></iframe>
        </div>
    </div>
    
    <footer>
        Built by <a href="https://itabs.ai" target="_blank">iTabs</a> ‚Ä¢ People learn easier and act
    </footer>
</div>

<script>
    // State
    let generatedSections = [];
    let videoId = '';
    
    // On load - check for saved API key
    document.addEventListener('DOMContentLoaded', () => {
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey) {
            document.getElementById('apiKey').value = savedKey;
            document.getElementById('keyStatus').innerHTML = '<div class="status success">‚úì API key loaded from browser</div>';
        }
        
        // Sync color inputs
        document.getElementById('brandColor').addEventListener('input', (e) => {
            document.getElementById('brandColorText').value = e.target.value;
        });
        document.getElementById('brandColorText').addEventListener('input', (e) => {
            if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                document.getElementById('brandColor').value = e.target.value;
            }
        });
    });
    
    function saveApiKey() {
        const key = document.getElementById('apiKey').value.trim();
        if (!key) {
            document.getElementById('keyStatus').innerHTML = '<div class="status error">Please enter your API key</div>';
            return;
        }
        localStorage.setItem('gemini_api_key', key);
        document.getElementById('keyStatus').innerHTML = '<div class="status success">‚úì API key saved</div>';
        goToPanel(2);
    }
    
    function goToPanel(num) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`panel${num}`).classList.add('active');
        
        document.querySelectorAll('.step').forEach((s, i) => {
            s.classList.remove('active', 'done');
            if (i + 1 < num) s.classList.add('done');
            if (i + 1 === num) s.classList.add('active');
        });
    }
    
    function extractVideoId(url) {
        if (!url) return '';
        const patterns = [
            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?\/]+)/,
            /^([a-zA-Z0-9_-]{11})$/
        ];
        for (const pattern of patterns) {
            const match = url.match(pattern);
            if (match) return match[1];
        }
        return '';
    }
    
    function parseTimestamp(ts) {
        // Convert various timestamp formats to seconds
        // Handles: [00:01:23], 1:23, 00:01:23, etc.
        const cleaned = ts.replace(/[\[\]]/g, '').trim();
        const parts = cleaned.split(':').map(Number);
        if (parts.length === 3) {
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        } else if (parts.length === 2) {
            return parts[0] * 60 + parts[1];
        }
        return 0;
    }
    
    function formatTimestamp(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function extractTimestampsFromText(text) {
        // Find all timestamps in the transcript
        const timestampRegex = /\[?(\d{1,2}:\d{2}(?::\d{2})?)\]?/g;
        const timestamps = [];
        let match;
        while ((match = timestampRegex.exec(text)) !== null) {
            timestamps.push({
                raw: match[0],
                seconds: parseTimestamp(match[1]),
                position: match.index
            });
        }
        return timestamps;
    }
    
    async function generateiTabs() {
        const apiKey = localStorage.getItem('gemini_api_key');
        const transcript = document.getElementById('transcript').value.trim();
        const youtubeUrl = document.getElementById('youtubeUrl').value.trim();
        const audience = document.getElementById('audience').value.trim();
        const goal = document.getElementById('goal').value.trim();
        const enableClips = document.getElementById('enableClips').checked;
        
        if (!apiKey) {
            document.getElementById('generateStatus').innerHTML = '<div class="status error">Please save your API key first</div>';
            return;
        }
        
        if (!transcript) {
            document.getElementById('generateStatus').innerHTML = '<div class="status error">Please paste some content</div>';
            return;
        }
        
        videoId = extractVideoId(youtubeUrl);
        
        // Extract timestamps from transcript
        const timestamps = extractTimestampsFromText(transcript);
        
        document.getElementById('generateStatus').innerHTML = '<div class="status loading">‚è≥ AI is creating your iTabs guide...</div>';
        
        const prompt = `You are an expert at creating teachable, action-focused guides.
```

Convert this transcript into an iTabs guide with 4-6 sections.

${audience ? `AUDIENCE: ${audience}` : ‚Äò‚Äô}
${goal ? `GOAL: ${goal}` : ‚Äò‚Äô}

TRANSCRIPT:
${transcript}

For each section, provide:

1. A clear title (2-5 words)
1. A badge label (one word like: Learn, Do, Setup, Check, Tips)
1. The start timestamp (from the transcript) - IMPORTANT: use the actual timestamps from the content
1. The end timestamp (when this section ends / next section begins)
1. A ‚ÄúSimple Explanation‚Äù tab - explain in plain language what this covers
1. A ‚ÄúKey Points‚Äù tab - bullet points of the important stuff
1. A ‚ÄúJon‚Äôs Note‚Äù - a practical personal note like ‚ÄúThis is the tricky bit - watch the hand position‚Äù

IMPORTANT: Extract the ACTUAL timestamps from the transcript for each section‚Äôs start and end times.

Respond in this exact JSON format:
{
‚Äútitle‚Äù: ‚ÄúSuggested guide title‚Äù,
‚Äúsections‚Äù: [
{
‚Äútitle‚Äù: ‚ÄúSection Title‚Äù,
‚Äúbadge‚Äù: ‚ÄúBadge‚Äù,
‚ÄústartTime‚Äù: ‚Äú0:00‚Äù,
‚ÄúendTime‚Äù: ‚Äú1:30‚Äù,
‚ÄúsimpleExplanation‚Äù: ‚ÄúPlain language explanation‚Ä¶‚Äù,
‚ÄúkeyPoints‚Äù: [‚ÄúPoint 1‚Äù, ‚ÄúPoint 2‚Äù, ‚ÄúPoint 3‚Äù],
‚ÄújonsNote‚Äù: ‚ÄúPractical tip‚Ä¶‚Äù
}
]
}`;

```
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 4096
                    }
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }
            
            let text = data.candidates[0].content.parts[0].text;
            
            // Extract JSON from response
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (!jsonMatch) throw new Error('Could not parse AI response');
            
            const result = JSON.parse(jsonMatch[0]);
            
            generatedSections = result.sections;
            document.getElementById('guideTitle').value = result.title || 'My iTabs Guide';
            
            // Build sections editor
            renderSectionsEditor();
            
            document.getElementById('generateStatus').innerHTML = '<div class="status success">‚úì iTabs generated! Review and download below.</div>';
            
            goToPanel(3);
            
        } catch (error) {
            document.getElementById('generateStatus').innerHTML = `<div class="status error">Error: ${error.message}</div>`;
        }
    }
    
    function renderSectionsEditor() {
        const container = document.getElementById('sectionsEditor');
        container.innerHTML = '<h3 style="margin: 20px 0 15px; color: var(--text-secondary);">Sections</h3>';
        
        generatedSections.forEach((section, index) => {
            const div = document.createElement('div');
            div.className = 'section-editor';
            div.innerHTML = `
                <div class="section-editor-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="section-number">${index + 1}</span>
                        <input type="text" value="${section.title}" onchange="generatedSections[${index}].title = this.value" style="margin: 0; font-weight: 600;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="timestamp-badge">${section.startTime} - ${section.endTime}</span>
                        <button class="delete-section" onclick="deleteSection(${index})">üóëÔ∏è</button>
                    </div>
                </div>
                <div style="display: grid; gap: 10px;">
                    <div>
                        <label style="font-size: 0.8rem;">Badge</label>
                        <input type="text" value="${section.badge}" onchange="generatedSections[${index}].badge = this.value" style="margin: 0;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 0.8rem;">Start Time</label>
                            <input type="text" value="${section.startTime}" onchange="generatedSections[${index}].startTime = this.value" style="margin: 0;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem;">End Time</label>
                            <input type="text" value="${section.endTime}" onchange="generatedSections[${index}].endTime = this.value" style="margin: 0;">
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem;">Simple Explanation</label>
                        <textarea onchange="generatedSections[${index}].simpleExplanation = this.value" style="margin: 0; min-height: 80px;">${section.simpleExplanation}</textarea>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem;">Jon's Note</label>
                        <input type="text" value="${section.jonsNote}" onchange="generatedSections[${index}].jonsNote = this.value" style="margin: 0;">
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    }
    
    function deleteSection(index) {
        generatedSections.splice(index, 1);
        renderSectionsEditor();
    }
    
    function generateOutputHTML() {
        const title = document.getElementById('guideTitle').value || 'iTabs Guide';
        const preparedFor = document.getElementById('preparedFor').value;
        const brandColor = document.getElementById('brandColor').value;
        const contactEmail = document.getElementById('contactEmail').value;
        const embedVideo = document.getElementById('embedVideo').checked;
        const enableClips = document.getElementById('enableClips').checked;
        
        // Generate clips array for JavaScript
        const clipsArray = generatedSections.map((s, i) => ({
            title: s.title,
            videoId: videoId,
            start: parseTimestamp(s.startTime),
            end: parseTimestamp(s.endTime),
            timeLabel: `${s.startTime} - ${s.endTime}`
        }));
        
        return `<!DOCTYPE html>
```

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <meta property="og:title" content="${title}">
    <meta property="og:description" content="Interactive guide - tap to learn">
    ${videoId ? `<meta property="og:image" content="https://img.youtube.com/vi/${videoId}/maxresdefault.jpg">` : ''}
    <style>
        :root {
            --brand: ${brandColor};
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #475569;
        }

```
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-dark);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
    }
    
    .container { max-width: 800px; margin: 0 auto; }
    
    header {
        text-align: center;
        padding: 30px 20px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 30px;
    }
    
    h1 {
        font-size: 1.8rem;
        color: var(--brand);
        margin-bottom: 10px;
    }
    
    .subtitle { color: var(--text-secondary); }
    
    .prepared-for {
        display: inline-block;
        background: var(--bg-card);
        border: 1px solid var(--brand);
        color: var(--brand);
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        margin-top: 15px;
    }
    
    /* Video embed */
    .video-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%;
        margin-bottom: 30px;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }
    
    /* Preload container - hidden */
    .preload-container {
        position: absolute;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
    }
    
    /* Loading status */
    .loading-status {
        background: var(--bg-card);
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 0.85rem;
        color: var(--text-secondary);
        text-align: center;
    }
    
    .loading-status.ready {
        color: #4ade80;
    }
    
    /* Sections */
    .itab-section {
        background: var(--bg-card);
        border-radius: 12px;
        margin-bottom: 16px;
        overflow: hidden;
        border: 1px solid var(--border);
        transition: border-color 0.2s;
    }
    
    .itab-section:hover {
        border-color: var(--brand);
    }
    
    .itab-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        cursor: pointer;
        transition: background 0.2s;
        gap: 10px;
    }
    
    .itab-header:hover { background: var(--bg-hover); }
    
    .itab-title {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }
    
    .itab-number {
        width: 32px;
        height: 32px;
        background: var(--brand);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--bg-dark);
        flex-shrink: 0;
    }
    
    .itab-name {
        font-size: 1rem;
        font-weight: 600;
    }
    
    .itab-badge {
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 20px;
        background: var(--bg-hover);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        flex-shrink: 0;
    }
    
    .itab-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .watch-btn {
        background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
        transition: transform 0.2s;
    }
    
    .watch-btn:hover {
        transform: scale(1.05);
    }
    
    .i-button {
        width: 32px;
        height: 32px;
        background: var(--brand);
        border: none;
        border-radius: 8px;
        color: var(--bg-dark);
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        font-family: serif;
        font-style: italic;
        transition: transform 0.2s;
    }
    
    .i-button:hover { transform: scale(1.1); }
    .i-button.active { background: #10b981; }
    
    .itab-content {
        display: none;
        padding: 0 20px 20px;
        border-top: 1px solid var(--border);
    }
    
    .itab-content.show { display: block; }
    
    /* Tabs */
    .tabs {
        display: flex;
        gap: 8px;
        padding: 15px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .tab {
        padding: 8px 16px;
        background: var(--bg-hover);
        border: none;
        border-radius: 8px;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .tab:hover { background: var(--border); }
    .tab.active {
        background: var(--brand);
        color: var(--bg-dark);
    }
    
    .tab-panel { display: none; }
    .tab-panel.show { display: block; }
    
    .tab-panel h3 {
        color: var(--brand);
        font-size: 1rem;
        margin-bottom: 12px;
    }
    
    .tab-panel p, .tab-panel li {
        color: var(--text-secondary);
        margin-bottom: 10px;
    }
    
    .tab-panel ul {
        padding-left: 20px;
    }
    
    /* Jon's Note */
    .jons-note {
        background: rgba(255, 217, 61, 0.1);
        border-left: 3px solid #ffd93d;
        padding: 12px 15px;
        border-radius: 0 8px 8px 0;
        margin-top: 15px;
    }
    
    .jons-note strong {
        color: #ffd93d;
    }
    
    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal-content {
        background: var(--bg-card);
        border-radius: 16px;
        width: 100%;
        max-width: 700px;
        max-height: 90vh;
        overflow: hidden;
        animation: modalSlideIn 0.25s ease;
    }
    
    @keyframes modalSlideIn {
        from { opacity: 0; transform: scale(0.95) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border);
    }
    
    .modal-title {
        color: var(--brand);
        font-size: 1.1rem;
    }
    
    .close-btn {
        background: var(--bg-hover);
        border: none;
        color: #fff;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
    }
    
    .close-btn:hover { background: #ff6b6b; }
    
    .modal-video {
        width: 100%;
        aspect-ratio: 16/9;
        background: #000;
        position: relative;
    }
    
    .modal-video iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    
    .modal-controls {
        padding: 15px 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
    }
    
    .replay-btn {
        background: var(--brand);
        color: var(--bg-dark);
        border: none;
        padding: 14px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-size: 1rem;
    }
    
    .replay-btn:hover { opacity: 0.9; }
    
    .modal-time {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    /* Footer */
    footer {
        text-align: center;
        padding: 30px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        border-top: 1px solid var(--border);
        margin-top: 30px;
    }
    
    footer a { color: var(--brand); text-decoration: none; }
    
    /* Support box */
    .support-box {
        background: var(--bg-card);
        border: 1px solid var(--brand);
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        margin-top: 30px;
    }
    
    .support-box h3 {
        color: var(--brand);
        margin-bottom: 10px;
    }
    
    .support-link {
        display: inline-block;
        margin-top: 15px;
        color: var(--brand);
        text-decoration: none;
        font-weight: 500;
    }
</style>
```

</head>
<body>
    <div class="container">
        <header>
            <h1>${title}</h1>
            <p class="subtitle">Interactive guide - tap sections to learn</p>
            ${preparedFor ? `<div class="prepared-for">Prepared for: ${preparedFor}</div>` : ''}
        </header>

```
    ${embedVideo && videoId ? `
    <div class="video-container">
        <iframe src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1" allowfullscreen></iframe>
    </div>
    ` : ''}
    
    ${enableClips && videoId ? `
    <div class="loading-status" id="loadingStatus">‚è≥ Loading video clips...</div>
    <div class="preload-container" id="preloadContainer"></div>
    ` : ''}
    
    ${generatedSections.map((section, index) => `
    <div class="itab-section">
        <div class="itab-header" onclick="toggleSection(this)">
            <div class="itab-title">
                <span class="itab-number">${index + 1}</span>
                <span class="itab-name">${section.title}</span>
                <span class="itab-badge">${section.badge}</span>
            </div>
            <div class="itab-buttons">
                ${enableClips && videoId ? `<button class="watch-btn" onclick="event.stopPropagation(); openClip(${index})">‚ñ∂Ô∏è Watch</button>` : ''}
                <button class="i-button">i</button>
            </div>
        </div>
        <div class="itab-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab(this, 'simple-${index}')">Simple</button>
                <button class="tab" onclick="showTab(this, 'points-${index}')">Key Points</button>
            </div>
            <div class="tab-panel show" id="simple-${index}">
                <h3>Simple Explanation</h3>
                <p>${section.simpleExplanation}</p>
            </div>
            <div class="tab-panel" id="points-${index}">
                <h3>Key Points</h3>
                <ul>
                    ${section.keyPoints.map(point => `<li>${point}</li>`).join('')}
                </ul>
            </div>
            <div class="jons-note">
                <strong>üí° Jon's Note:</strong> ${section.jonsNote}
            </div>
        </div>
    </div>
    `).join('')}
    
    ${contactEmail ? `
    <div class="support-box">
        <h3>Need Help?</h3>
        <p>Questions about this guide?</p>
        <a href="mailto:${contactEmail}" class="support-link">Get in touch ‚Üí</a>
    </div>
    ` : ''}
    
    <footer>
        <p>Built with <a href="https://itabs.ai" target="_blank">iTabs</a> ‚Ä¢ People learn easier and act</p>
    </footer>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Section</div>
            <button class="close-btn" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-video" id="modalVideo"></div>
        <div class="modal-controls">
            <button class="replay-btn" onclick="replayClip()">üîÑ Replay Section</button>
            <span class="modal-time" id="modalTime"></span>
        </div>
    </div>
</div>

<script>
    // Section toggle
    function toggleSection(header) {
        const content = header.nextElementSibling;
        const button = header.querySelector('.i-button');
        content.classList.toggle('show');
        button.classList.toggle('active');
    }
    
    // Tab switching
    function showTab(tabButton, panelId) {
        const container = tabButton.closest('.itab-content');
        container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        container.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('show'));
        tabButton.classList.add('active');
        document.getElementById(panelId).classList.add('show');
    }
    
    ${enableClips && videoId ? `
    // Video clips configuration
    const clips = ${JSON.stringify(clipsArray)};
    
    let players = [];
    let currentClipIndex = -1;
    let activePlayer = null;
    let apiReady = false;
    
    // Load YouTube API
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
    
    function onYouTubeIframeAPIReady() {
        apiReady = true;
        preloadAllClips();
    }
    
    function preloadAllClips() {
        const container = document.getElementById('preloadContainer');
        if (!container) return;
        
        clips.forEach((clip, index) => {
            const div = document.createElement('div');
            div.id = 'preload-' + index;
            container.appendChild(div);
            
            players[index] = new YT.Player('preload-' + index, {
                height: '180',
                width: '320',
                videoId: clip.videoId,
                playerVars: {
                    start: clip.start,
                    end: clip.end,
                    rel: 0,
                    modestbranding: 1,
                    playsinline: 1,
                    enablejsapi: 1
                },
                events: {
                    onReady: function(event) {
                        event.target.cueVideoById({
                            videoId: clip.videoId,
                            startSeconds: clip.start,
                            endSeconds: clip.end
                        });
                        checkAllLoaded();
                    }
                }
            });
        });
    }
    
    let loadedCount = 0;
    function checkAllLoaded() {
        loadedCount++;
        const status = document.getElementById('loadingStatus');
        if (loadedCount >= clips.length && status) {
            status.innerHTML = '‚úÖ Video clips ready - tap Watch to play';
            status.classList.add('ready');
        }
    }
    
    function openClip(index) {
        if (!apiReady || !players[index]) {
            alert('Still loading, try again');
            return;
        }
        
        currentClipIndex = index;
        const clip = clips[index];
        
        document.getElementById('modalTitle').textContent = clip.title;
        document.getElementById('modalTime').textContent = clip.timeLabel;
        
        const modalVideo = document.getElementById('modalVideo');
        const playerElement = players[index].getIframe();
        
        playerElement.style.width = '100%';
        playerElement.style.height = '100%';
        playerElement.style.position = 'absolute';
        playerElement.style.left = '0';
        playerElement.style.top = '0';
        
        modalVideo.appendChild(playerElement);
        
        document.getElementById('modalOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
        
        players[index].seekTo(clip.start, true);
        players[index].playVideo();
        
        activePlayer = players[index];
    }
    
    function replayClip() {
        if (currentClipIndex >= 0 && players[currentClipIndex]) {
            const clip = clips[currentClipIndex];
            players[currentClipIndex].seekTo(clip.start, true);
            players[currentClipIndex].playVideo();
        }
    }
    
    function closeModal(event) {
        if (!event || event.target.id === 'modalOverlay') {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
            
            if (activePlayer) activePlayer.pauseVideo();
            
            if (currentClipIndex >= 0 && players[currentClipIndex]) {
                const preloadDiv = document.getElementById('preload-' + currentClipIndex);
                const playerElement = players[currentClipIndex].getIframe();
                if (preloadDiv && playerElement) {
                    playerElement.style.width = '320px';
                    playerElement.style.height = '180px';
                    playerElement.style.position = '';
                    preloadDiv.appendChild(playerElement);
                }
            }
            
            currentClipIndex = -1;
            activePlayer = null;
        }
    }
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal({ target: { id: 'modalOverlay' } });
    });
    ` : ''}
    
    // Open first section on load
    document.addEventListener('DOMContentLoaded', function() {
        const first = document.querySelector('.itab-header');
        if (first) toggleSection(first);
    });
</script>
```

</body>
</html>`;`;
        }

```
    function previewGuide() {
        const html = generateOutputHTML();
        const iframe = document.getElementById('previewFrame');
        iframe.srcdoc = html;
        document.getElementById('previewModal').style.display = 'block';
    }
    
    function closePreview() {
        document.getElementById('previewModal').style.display = 'none';
    }
    
    function downloadGuide() {
        const html = generateOutputHTML();
        const title = document.getElementById('guideTitle').value || 'itabs-guide';
        const filename = title.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '.html';
        
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
```

</body>
</html>
